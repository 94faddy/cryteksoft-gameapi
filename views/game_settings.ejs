<%- include('partials/header', { user: user }) %>

<style>
    /* Custom styles for game settings page, adjusted for consistency */
    .setting-card {
        background-color: #212529; /* Consistent dark color */
        color: #f8f9fa;
        border: 1px solid #495057;
        border-radius: 0.75rem;
        padding: 2rem;
        margin-bottom: 1.5rem;
    }
    .form-range::-webkit-slider-thumb {
        background: #5a8dee;
    }
    .form-range::-moz-range-thumb {
        background: #5a8dee;
    }
    .range-value {
        font-weight: bold;
        color: #5a8dee;
    }
    label.form-label {
        font-weight: 500;
        color: #ced4da;
    }
    .input-group-text {
        background-color: #343a40;
        color: #fff;
        border-color: #495057;
    }
    .form-control {
        background-color: #343a40;
        color: #fff;
        border: 1px solid #495057;
    }
    .form-control:focus {
        background-color: #343a40;
        color: #fff;
        border-color: #5a8dee;
        box-shadow: 0 0 0 0.25rem rgba(90, 141, 238, 0.25);
    }
    .btn-primary {
        background-color: #5a8dee;
        border: none;
    }
    .preset-btn-group .btn {
        margin: 0 5px;
        font-size: 0.9rem;
    }
</style>

<div class="container my-5">
    <h2 class="mb-4 text-white text-center">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏° (<%= user.name %>)</h2>

    <div class="setting-card text-center">
        <h4 class="mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Presets)</h4>
        <p class="text-white-50 mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
        <div class="preset-btn-group">
            <button type="button" class="btn btn-outline-danger" id="preset-house-advantage">
                <i class="bi bi-trophy-fill"></i> ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á (RTP ~7-10%)
            </button>
            <button type="button" class="btn btn-outline-info" id="preset-balanced">
                <i class="bi bi-heptagon-half"></i> ‡∏™‡∏°‡∏î‡∏∏‡∏• (RTP ~55-65%, ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
            </button>
            <button type="button" class="btn btn-outline-success" id="preset-player-friendly">
                <i class="bi bi-heart-fill"></i> ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö (RTP ~55-65%)
            </button>
        </div>
        
        <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Presets -->
        <div class="mt-4 text-start">
            <div class="alert alert-info">
                <h6 class="fw-bold mb-2">üìå ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Presets:</h6>
                <ul class="mb-0 small">
                    <li><strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á (RTP ~7-10%)</strong>: Free Spin ‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å (1/50+ ‡∏£‡∏≠‡∏ö), ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡πá‡∏ß, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á ~90-93%</li>
                    <li><strong>‡∏™‡∏°‡∏î‡∏∏‡∏• (RTP ~55-65%, ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</strong>: ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞ 25-30%, ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏™‡∏µ‡∏¢ 70-75%, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö ~35-45%</li>
                    <li><strong>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö (RTP ~55-65%)</strong>: Free Spin ‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ (1/50 ‡∏£‡∏≠‡∏ö), ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ä‡∏ô‡∏∞‡∏ö‡πà‡∏≠‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏ô‡πâ‡∏≠‡∏¢ ~35-45%</li>
                </ul>
            </div>
        </div>
    </div>

    <form id="gameSettingsForm">
        <div class="setting-card">
            <h4 class="mb-4">Normal Game (Spin)</h4>
            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <label for="normal-spin" class="form-label">Normal Spin (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="normal-spin-value"></span></label>
                    <input type="range" class="form-range" id="normal-spin" name="normal-spin" min="0" max="100" step="0.1" value="<%= user.gameSettings['normal-spin'] %>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="less-bet" class="form-label">Less Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="less-bet-value"></span></label>
                    <input type="range" class="form-range" id="less-bet" name="less-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['less-bet'] %>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="more-bet" class="form-label">More Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="more-bet-value"></span></label>
                    <input type="range" class="form-range" id="more-bet" name="more-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['more-bet'] %>">
                </div>
            </div>
             <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Less Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                    <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="less-bet-from" value="<%= user.gameSettings['less-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="less-bet-to" value="<%= user.gameSettings['less-bet-to'] %>"></div>
                    </div>
                <div class="col-md-6">
                    <label class="form-label">More Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                    <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="more-bet-from" value="<%= user.gameSettings['more-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="more-bet-to" value="<%= user.gameSettings['more-bet-to'] %>"></div>
                    </div>
            </div>
        </div>
        
        <div class="setting-card">
            <h4 class="mb-4">Free Spin</h4>
            <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <label for="freespin-less-bet" class="form-label">Free Spin Less Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="freespin-less-bet-value"></span></label>
                    <input type="range" class="form-range" id="freespin-less-bet" name="freespin-less-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['freespin-less-bet'] %>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="freespin-more-bet" class="form-label">Free Spin More Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="freespin-more-bet-value"></span></label>
                    <input type="range" class="form-range" id="freespin-more-bet" name="freespin-more-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['freespin-more-bet'] %>">
                </div>
            </div>
             <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Free Spin Less Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                     <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="freespin-less-bet-from" value="<%= user.gameSettings['freespin-less-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="freespin-less-bet-to" value="<%= user.gameSettings['freespin-less-bet-to'] %>"></div>
                     </div>
                <div class="col-md-6">
                    <label class="form-label">Free Spin More Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                     <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="freespin-more-bet-from" value="<%= user.gameSettings['freespin-more-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="freespin-more-bet-to" value="<%= user.gameSettings['freespin-more-bet-to'] %>"></div>
                     </div>
            </div>
        </div>
        
        <div class="setting-card">
            <h4 class="mb-4">Buy Feature</h4>
             <div class="row mb-3">
                <div class="col-md-6 mb-3">
                    <label for="buy-feature-less-bet" class="form-label">Buy Feature Less Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="buy-feature-less-bet-value"></span></label>
                    <input type="range" class="form-range" id="buy-feature-less-bet" name="buy-feature-less-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['buy-feature-less-bet'] %>">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="buy-feature-more-bet" class="form-label">Buy Feature More Bet (‡πÇ‡∏≠‡∏Å‡∏≤‡∏™): <span class="range-value" id="buy-feature-more-bet-value"></span></label>
                    <input type="range" class="form-range" id="buy-feature-more-bet" name="buy-feature-more-bet" min="0" max="100" step="0.1" value="<%= user.gameSettings['buy-feature-more-bet'] %>">
                </div>
             </div>
             <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Buy Feature Less Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                     <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="buy-feature-less-bet-from" value="<%= user.gameSettings['buy-feature-less-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="buy-feature-less-bet-to" value="<%= user.gameSettings['buy-feature-less-bet-to'] %>"></div>
                     </div>
                 <div class="col-md-6">
                    <label class="form-label">Buy Feature More Bet (‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Min/Max)</label>
                     <div class="input-group"><input type="number" min="0" step="0.1" class="form-control" name="buy-feature-more-bet-from" value="<%= user.gameSettings['buy-feature-more-bet-from'] %>"><span class="input-group-text">-</span><input type="number" min="0" step="0.1" class="form-control" name="buy-feature-more-bet-to" value="<%= user.gameSettings['buy-feature-more-bet-to'] %>"></div>
                     </div>
             </div>
        </div>

        <div class="d-grid">
            <button type="submit" class="btn btn-primary px-5 py-2 fs-5">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('gameSettingsForm');
    
    // Presets ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà
    const presets = {
        house_advantage: { // ‡∏à‡∏≤‡∏Å update-settings.js (RTP ~7-10%, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á)
            'normal-spin': 85, 'less-bet': 12, 'less-bet-from': 0, 'less-bet-to': 0.5,
            'more-bet': 3, 'more-bet-from': 0.8, 'more-bet-to': 2,
            'freespin-less-bet': 2, 'freespin-less-bet-from': 0, 'freespin-less-bet-to': 0,
            'freespin-more-bet': 0.5, 'freespin-more-bet-from': 0, 'freespin-more-bet-to': 15,
            'buy-feature-less-bet': 80, 'buy-feature-less-bet-from': 0, 'buy-feature-less-bet-to': 20,
            'buy-feature-more-bet': 8, 'buy-feature-more-bet-from': 20, 'buy-feature-more-bet-to': 60
        },
        balanced: { // ‡∏à‡∏≤‡∏Å update-settings-v2.js (RTP ~55-65%, ‡∏™‡∏°‡∏î‡∏∏‡∏•)
            'normal-spin': 50, 'less-bet': 35, 'less-bet-from': 0, 'less-bet-to': 1.2,
            'more-bet': 15, 'more-bet-from': 1.5, 'more-bet-to': 4,
            'freespin-less-bet': 3, 'freespin-less-bet-from': 2, 'freespin-less-bet-to': 10,
            'freespin-more-bet': 1, 'freespin-more-bet-from': 10, 'freespin-more-bet-to': 30,
            'buy-feature-less-bet': 65, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 40,
            'buy-feature-more-bet': 20, 'buy-feature-more-bet-from': 40, 'buy-feature-more-bet-to': 100
        },
        player_friendly: { // ‡∏à‡∏≤‡∏Å update-settings-v4.js (RTP ~55-65%, ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö)
            'normal-spin': 55, 'less-bet': 32, 'less-bet-from': 0.2, 'less-bet-to': 1.1,
            'more-bet': 13, 'more-bet-from': 1.5, 'more-bet-to': 3.5,
            'freespin-less-bet': 1.5, 'freespin-less-bet-from': 1, 'freespin-less-bet-to': 8,
            'freespin-more-bet': 0.5, 'freespin-more-bet-from': 8, 'freespin-more-bet-to': 20,
            'buy-feature-less-bet': 70, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 30,
            'buy-feature-more-bet': 15, 'buy-feature-more-bet-from': 30, 'buy-feature-more-bet-to': 80
        }
    };
    
    function applyPreset(presetName) {
        const selectedPreset = presets[presetName];
        if (!selectedPreset) return;
        for (const key in selectedPreset) {
            const input = form.elements[key];
            if (input) {
                input.value = selectedPreset[key];
                if (input.type === 'range') {
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }
        Swal.fire({
            icon: 'info', title: '‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
            text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á',
            toast: true, position: 'top-end',
            showConfirmButton: false, timer: 3000
        });
    }
    
    document.getElementById('preset-house-advantage').addEventListener('click', () => applyPreset('house_advantage'));
    document.getElementById('preset-balanced').addEventListener('click', () => applyPreset('balanced'));
    document.getElementById('preset-player-friendly').addEventListener('click', () => applyPreset('player_friendly'));
    
    function initializeSliders() {
        const sliders = [
            'normal-spin', 'less-bet', 'more-bet', 
            'freespin-less-bet', 'freespin-more-bet',
            'buy-feature-less-bet', 'buy-feature-more-bet'
        ];
        sliders.forEach(id => {
            const range = document.getElementById(id);
            const valueSpan = document.getElementById(id + '-value');
            if(range && valueSpan) {
                const updateValue = () => { 
                    valueSpan.textContent = `(${parseFloat(range.value).toFixed(1)}%)`; 
                };
                range.addEventListener('input', updateValue);
                updateValue();
            }
        });
    }
    initializeSliders();
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        try {
            const response = await fetch('/api/user/update-game-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                Swal.fire({
                    icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß',
                    timer: 2000, showConfirmButton: false
                });
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            Swal.fire({
                icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Server ‡πÑ‡∏î‡πâ'
            });
        }
    });
});
</script>

<%- include('partials/footer') %>
