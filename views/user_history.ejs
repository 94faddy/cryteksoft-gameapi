<%- include('partials/header') %>

<div class="container-fluid">
    <h3 class="mb-4 text-white"><i class="fa-solid fa-users me-2"></i><%= title %></h3>

    <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
    <div class="card bg-dark text-light mb-4">
        <div class="card-header bg-secondary bg-opacity-25 border-secondary">
            <i class="fa-solid fa-filter me-2"></i>‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="text" id="filterStartDate" class="form-control bg-dark text-light" placeholder="MM/DD/YYYY" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="text" id="filterEndDate" class="form-control bg-dark text-light" placeholder="MM/DD/YYYY" />
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="btnSearch" class="btn btn-primary w-100">
                        <i class="fa-solid fa-search me-1"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username -->
    <div class="card bg-dark text-light mb-4">
        <div class="card-header bg-secondary bg-opacity-25 border-secondary">
            <i class="fa-solid fa-search me-2"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username
        </div>
        <div class="card-body">
            <input type="text" id="usernameSearchInput" class="form-control bg-dark text-light" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå Username ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
        </div>
    </div>

    <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏° -->
    <div class="card bg-dark text-light mb-4">
        <div class="card-body">
            <h5 class="card-title">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏° (<span id="stats-display-title">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>)</h5>
            <div class="row text-center">
                <div class="col-md-3">
                    <div class="card bg-info text-white p-3">
                        <h6 class="mb-0">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Username</h6>
                        <h4 id="total-usernames">0</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white p-3">
                        <h6 class="mb-0">Total Bet</h6>
                        <h4 id="total-bet">0.00</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white p-3">
                        <h6 class="mb-0">Total Win</h6>
                        <h4 id="total-win">0.00</h4>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white p-3">
                        <h6 class="mb-0">Win/Loss</h6>
                        <h4 id="total-winloss">0.00</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á Username -->
    <div class="card bg-dark text-light">
        <div class="card-header bg-secondary bg-opacity-25 border-secondary">
            <i class="fa-solid fa-table me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Username ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-dark table-striped table-hover" id="usernamesTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Total Bet</th>
                            <th>Total Win</th>
                            <th>Win/Loss</th>
                            <th>Spin</th>
                            <th>‡πÄ‡∏•‡πà‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usernamesTableBody">
                        <tr>
                            <td colspan="7" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header bg-primary text-white border-secondary">
                <h5 class="modal-title" id="historyModalLabel">
                    <i class="fa-solid fa-clock-rotate-left me-2"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏ô‡∏Ç‡∏≠‡∏á: <span id="modal-username" class="fw-bold"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ -->
                <div class="card bg-secondary mb-3">
                    <div class="card-header">
                        <i class="fa-solid fa-filter me-2"></i>‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">‡∏à‡∏≤‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="text" id="modalStartDate" class="form-control bg-dark text-light" placeholder="MM/DD/YYYY" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                                <input type="time" id="modalStartTime" class="form-control bg-dark text-light" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="text" id="modalEndDate" class="form-control bg-dark text-light" placeholder="MM/DD/YYYY" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤</label>
                                <input type="time" id="modalEndTime" class="form-control bg-dark text-light" />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="btnModalSearch" class="btn btn-primary w-100">
                                    <i class="fa-solid fa-search me-1"></i>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                                </button>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="btnModalReset" class="btn btn-secondary w-100">
                                    <i class="fa-solid fa-rotate-right me-1"></i>‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡πà‡∏≠‡∏¢ -->
                <div class="card bg-secondary mb-3">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <strong>Total Bet:</strong>
                                <h5 id="modal-total-bet" class="text-primary">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Total Win:</strong>
                                <h5 id="modal-total-win" class="text-success">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Win/Loss:</strong>
                                <h5 id="modal-win-loss" class="text-danger">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Spin:</strong>
                                <h5 id="modal-total-games" class="text-info">0</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
                <div class="table-responsive">
                    <table class="table table-sm table-dark table-bordered table-hover" id="historyTable">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>‡πÄ‡∏Å‡∏°</th>
                                <th>Provider</th>
                                <th>Bet</th>
                                <th>Win</th>
                                <th>Win/Loss</th>
                                <th>Currency</th>
                                <th>Transaction ID</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>
</div>

<!-- ‚úÖ Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏° (Per-User Settings) -->
<div class="modal fade" id="gameSettingsModal" tabindex="-1" aria-labelledby="gameSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <form id="gameSettingsForm">
                <div class="modal-header bg-primary text-white border-secondary">
                    <h5 class="modal-title" id="gameSettingsModalLabel">
                        <i class="fa-solid fa-gamepad me-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <span id="settings-modal-username" class="fw-bold"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î: ‡πÉ‡∏ä‡πâ Agent Settings ‡∏´‡∏£‡∏∑‡∏≠ Custom -->
                    <div class="card bg-secondary mb-4">
                        <div class="card-body">
                            <h6 class="mb-3">‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</h6>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="settingsMode" id="useAgentSettings" value="agent" checked>
                                <label class="form-check-label" for="useAgentSettings">
                                    ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Agent (Default)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="settingsMode" id="useCustomSettings" value="custom">
                                <label class="form-check-label" for="useCustomSettings">
                                    ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏á (Custom per-user)
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- ‡∏™‡πà‡∏ß‡∏ô Custom Settings -->
                    <div id="customSettingsSection" style="display: none;">
                        <!-- Presets -->
                        <div class="text-center mb-4 p-3 bg-secondary rounded">
                            <h6 class="mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Presets)</h6>
                            <div class="preset-btn-group">
                                <button type="button" class="btn btn-sm btn-outline-danger" id="preset-house-advantage">
                                    ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á (RTP ~7-10%)
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" id="preset-balanced">
                                    ‡∏™‡∏°‡∏î‡∏∏‡∏• (RTP ~55-65%, ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="preset-player-friendly">
                                    ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö (RTP ~55-65%)
                                </button>
                            </div>
                            <div class="mt-3 text-start">
                                <div class="alert alert-info mb-0">
                                    <small>
                                        <strong>üìå ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong><br>
                                        ‚Ä¢ <strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á:</strong> Free Spin ‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£ ~90-93%<br>
                                        ‚Ä¢ <strong>‡∏™‡∏°‡∏î‡∏∏‡∏•:</strong> ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞ 25-30%, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö ~35-45%<br>
                                        ‚Ä¢ <strong>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö:</strong> Free Spin ‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏ô‡πâ‡∏≠‡∏¢ ~35-45%
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Form -->
                        <div id="settings-form-content"></div>
                    </div>

                    <div id="settings-form-loader" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    #historyTable img.game-icon {
        width: 32px;
        height: 32px;
        border-radius: 5px;
        margin-right: 8px;
        vertical-align: middle;
    }
    #historyTable th, #historyTable td {
        white-space: nowrap;
        vertical-align: middle;
    }
    .preset-btn-group .btn {
        margin: 0 5px;
        font-size: 0.9rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const usernamesTableBody = document.getElementById('usernamesTableBody');
    const usernameSearchInput = document.getElementById('usernameSearchInput');
    const filterStartDate = document.getElementById('filterStartDate');
    const filterEndDate = document.getElementById('filterEndDate');
    const btnSearch = document.getElementById('btnSearch');
    
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    const modalUsername = document.getElementById('modal-username');
    const historyTableBody = document.getElementById('historyTableBody');
    const modalStartDate = document.getElementById('modalStartDate');
    const modalEndDate = document.getElementById('modalEndDate');
    const modalStartTime = document.getElementById('modalStartTime');
    const modalEndTime = document.getElementById('modalEndTime');
    const btnModalSearch = document.getElementById('btnModalSearch');
    const btnModalReset = document.getElementById('btnModalReset');

    // ‚úÖ Game Settings Modal
    const gameSettingsModal = new bootstrap.Modal(document.getElementById('gameSettingsModal'));
    const gameSettingsForm = document.getElementById('gameSettingsForm');
    const settingsModalUsername = document.getElementById('settings-modal-username');
    const settingsFormContent = document.getElementById('settings-form-content');
    const settingsFormLoader = document.getElementById('settings-form-loader');
    const customSettingsSection = document.getElementById('customSettingsSection');
    const useAgentSettings = document.getElementById('useAgentSettings');
    const useCustomSettings = document.getElementById('useCustomSettings');

    let currentUsername = '';
    let allPlayers = [];

    // Default Settings
    const defaultSettings = {
        'normal-spin': 85, 'less-bet': 35, 'less-bet-from': 0, 'less-bet-to': 1,
        'more-bet': 8, 'more-bet-from': 2, 'more-bet-to': 4,
        'freespin-less-bet': 1, 'freespin-less-bet-from': 0, 'freespin-less-bet-to': 4,
        'freespin-more-bet': 0, 'freespin-more-bet-from': 50, 'freespin-more-bet-to': 60,
        'buy-feature-less-bet': 90, 'buy-feature-less-bet-from': 0, 'buy-feature-less-bet-to': 50,
        'buy-feature-more-bet': 4, 'buy-feature-more-bet-from': 50, 'buy-feature-more-bet-to': 60
    };

    // Presets
    const presets = {
        house_advantage: {
            'normal-spin': 85, 'less-bet': 12, 'less-bet-from': 0, 'less-bet-to': 0.5,
            'more-bet': 3, 'more-bet-from': 0.8, 'more-bet-to': 2,
            'freespin-less-bet': 2, 'freespin-less-bet-from': 0, 'freespin-less-bet-to': 0,
            'freespin-more-bet': 0.5, 'freespin-more-bet-from': 0, 'freespin-more-bet-to': 15,
            'buy-feature-less-bet': 80, 'buy-feature-less-bet-from': 0, 'buy-feature-less-bet-to': 20,
            'buy-feature-more-bet': 8, 'buy-feature-more-bet-from': 20, 'buy-feature-more-bet-to': 60
        },
        balanced: {
            'normal-spin': 50, 'less-bet': 35, 'less-bet-from': 0, 'less-bet-to': 1.2,
            'more-bet': 15, 'more-bet-from': 1.5, 'more-bet-to': 4,
            'freespin-less-bet': 3, 'freespin-less-bet-from': 2, 'freespin-less-bet-to': 10,
            'freespin-more-bet': 1, 'freespin-more-bet-from': 10, 'freespin-more-bet-to': 30,
            'buy-feature-less-bet': 65, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 40,
            'buy-feature-more-bet': 20, 'buy-feature-more-bet-from': 40, 'buy-feature-more-bet-to': 100
        },
        player_friendly: {
            'normal-spin': 55, 'less-bet': 32, 'less-bet-from': 0.2, 'less-bet-to': 1.1,
            'more-bet': 13, 'more-bet-from': 1.5, 'more-bet-to': 3.5,
            'freespin-less-bet': 1.5, 'freespin-less-bet-from': 1, 'freespin-less-bet-to': 8,
            'freespin-more-bet': 0.5, 'freespin-more-bet-from': 8, 'freespin-more-bet-to': 20,
            'buy-feature-less-bet': 70, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 30,
            'buy-feature-more-bet': 15, 'buy-feature-more-bet-from': 30, 'buy-feature-more-bet-to': 80
        }
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Datepicker
    const startDatePicker = $(filterStartDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const endDatePicker = $(filterEndDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const modalStartDatePicker = $(modalStartDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const modalEndDatePicker = $(modalEndDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Players
    async function loadPlayers(start = '', end = '') {
        usernamesTableBody.innerHTML = '<tr><td colspan="7" class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></td></tr>';
        
        try {
            let url = '/api/user/all-players';
            if (start && end) {
                url += `?start=${start}&end=${end}`;
            }

            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                allPlayers = result.players;
                displayPlayers(allPlayers);
                updateStats(allPlayers);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error loading players:', error);
            usernamesTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '</td></tr>';
        }
    }

    // ‡πÅ‡∏™‡∏î‡∏á Players ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function displayPlayers(players) {
        if (players.length === 0) {
            usernamesTableBody.innerHTML = '<tr><td colspan="7" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            return;
        }

        usernamesTableBody.innerHTML = players.map(player => {
            const winLossClass = player.winLoss >= 0 ? 'text-success' : 'text-danger';
            const lastPlayed = new Date(player.lastPlayed).toLocaleString('th-TH');
            
            return `
                <tr>
                    <td><strong>${player.username}</strong></td>
                    <td>${player.totalBet.toFixed(2)}</td>
                    <td>${player.totalWin.toFixed(2)}</td>
                    <td class="${winLossClass}">${player.winLoss.toFixed(2)}</td>
                    <td>${player.totalGames}</td>
                    <td><small>${lastPlayed}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-history-btn me-1" data-username="${player.username}">
                            <i class="fa-solid fa-clock-rotate-left me-1"></i>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        </button>
                        <button class="btn btn-sm btn-outline-warning settings-btn" data-username="${player.username}">
                            <i class="fa-solid fa-gamepad me-1"></i>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        document.querySelectorAll('.view-history-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentUsername = this.getAttribute('data-username');
                loadPlayerHistory(currentUsername);
            });
        });

        // ‡∏ú‡∏π‡∏Å Event ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        document.querySelectorAll('.settings-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentUsername = this.getAttribute('data-username');
                loadPlayerSettings(currentUsername);
            });
        });
    }

    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°
    function updateStats(players) {
        const stats = players.reduce((acc, player) => {
            acc.totalBet += player.totalBet;
            acc.totalWin += player.totalWin;
            acc.totalWinLoss += player.winLoss;
            return acc;
        }, { totalBet: 0, totalWin: 0, totalWinLoss: 0 });

        document.getElementById('total-usernames').textContent = players.length;
        document.getElementById('total-bet').textContent = stats.totalBet.toFixed(2);
        document.getElementById('total-win').textContent = stats.totalWin.toFixed(2);
        document.getElementById('total-winloss').textContent = stats.totalWinLoss.toFixed(2);
    }

    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Username
    usernameSearchInput.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = usernamesTableBody.getElementsByTagName('tr');

        for (let row of rows) {
            const textContent = row.textContent || row.innerText;
            if (textContent.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    btnSearch.addEventListener('click', function() {
        const start = startDatePicker.value();
        const end = endDatePicker.value();

        if (start && !end || !start && end) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'warning');
            return;
        }

        loadPlayers(start, end);
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ Player
    async function loadPlayerHistory(username, start = '', end = '', startTime = '', endTime = '') {
        modalUsername.textContent = username;
        historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>';
        historyModal.show();

        try {
            let url = `/api/user/player-detail/${username}`;
            const params = [];
            if (start) params.push(`start=${start}`);
            if (end) params.push(`end=${end}`);
            if (startTime) params.push(`startTime=${startTime}`);
            if (endTime) params.push(`endTime=${endTime}`);
            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                displayPlayerHistory(result.history, result.summary);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error loading player history:', error);
            historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message + '</td></tr>';
        }
    }

    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    function displayPlayerHistory(history, summary) {
        document.getElementById('modal-total-bet').textContent = summary.totalBet.toFixed(2);
        document.getElementById('modal-total-win').textContent = summary.totalWin.toFixed(2);
        document.getElementById('modal-win-loss').textContent = summary.winLoss.toFixed(2);
        document.getElementById('modal-total-games').textContent = summary.totalGames;

        if (history.length === 0) {
            historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            return;
        }

        historyTableBody.innerHTML = history.map(tx => {
            const winLossClass = tx.winLoss >= 0 ? 'text-success' : 'text-danger';
            const createdDate = new Date(tx.createdDate).toLocaleString('th-TH');
            const gameDisplay = `<img src="${tx.imageUrl}" class="game-icon" alt="${tx.gameName}" onerror="this.onerror=null;this.src='/img/default-game.png';"><span>${tx.gameName}</span>`;
            
            return `
                <tr>
                    <td><small>${createdDate}</small></td>
                    <td>${gameDisplay}</td>
                    <td>${tx.productId}</td>
                    <td>${tx.betAmount.toFixed(2)}</td>
                    <td>${tx.payoutAmount.toFixed(2)}</td>
                    <td class="${winLossClass}">${tx.winLoss.toFixed(2)}</td>
                    <td>${tx.currency}</td>
                    <td><small>${tx.transactionId}</small></td>
                </tr>
            `;
        }).join('');
    }

    // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    btnModalSearch.addEventListener('click', function() {
        const start = modalStartDatePicker.value();
        const end = modalEndDatePicker.value();
        const startTime = modalStartTime.value;
        const endTime = modalEndTime.value;

        if (start && !end || !start && end) {
            Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î', 'warning');
            return;
        }

        loadPlayerHistory(currentUsername, start, end, startTime, endTime);
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÉ‡∏ô Modal ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    btnModalReset.addEventListener('click', function() {
        modalStartDatePicker.value('');
        modalEndDatePicker.value('');
        modalStartTime.value = '';
        modalEndTime.value = '';
        loadPlayerHistory(currentUsername);
    });

    // ===================================================================
    // ‚úÖ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Game Settings Modal
    // ===================================================================

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏´‡∏°‡∏î: Agent Settings <-> Custom Settings
    useAgentSettings.addEventListener('change', function() {
        if (this.checked) {
            customSettingsSection.style.display = 'none';
        }
    });

    useCustomSettings.addEventListener('change', function() {
        if (this.checked) {
            customSettingsSection.style.display = 'block';
        }
    });

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Settings ‡∏Ç‡∏≠‡∏á Player
    async function loadPlayerSettings(username) {
        settingsModalUsername.textContent = username;
        settingsFormContent.innerHTML = '';
        settingsFormLoader.classList.remove('d-none');
        customSettingsSection.style.display = 'none';
        gameSettingsModal.show();

        try {
            const response = await fetch(`/api/user/player-settings/${username}`);
            const data = await response.json();

            if (!data.success) throw new Error(data.message);

            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Radio Button
            if (data.useAgentSettings) {
                useAgentSettings.checked = true;
                customSettingsSection.style.display = 'none';
            } else {
                useCustomSettings.checked = true;
                customSettingsSection.style.display = 'block';
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° Settings
            const settings = { ...defaultSettings, ...data.settings };
            buildSettingsForm(settings);

        } catch (error) {
            Swal.fire({ 
                icon: 'error', 
                title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', 
                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: ' + error.message 
            });
            gameSettingsModal.hide();
        } finally {
            settingsFormLoader.classList.add('d-none');
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° Settings
    function buildSettingsForm(settings) {
        const formHtml = `
            <div class="row">
                ${Object.keys(defaultSettings).map(key => {
                    const value = settings[key] !== undefined ? settings[key] : defaultSettings[key];
                    const label = key.replace(/-/g, ' ');
                    
                    if (key.includes('-bet') && !key.includes('-from') && !key.includes('-to') || key.includes('normal-spin')) {
                        return `
                        <div class="col-md-6 mb-3">
                            <label for="setting-${key}" class="form-label">${label} 
                                <span id="setting-${key}-value" class="text-primary fw-bold"></span>
                            </label>
                            <input type="range" class="form-range" id="setting-${key}" name="${key}" min="0.1" max="100" step="0.1" value="${value}">
                        </div>`;
                    } else {
                        return `
                        <div class="col-md-6 mb-3">
                            <label for="setting-${key}" class="form-label">${label}</label>
                            <input type="number" min="0" step="0.1" class="form-control bg-dark text-light" id="setting-${key}" name="${key}" value="${value}">
                        </div>`;
                    }
                }).join('')}
            </div>
        `;
        settingsFormContent.innerHTML = formHtml;
        setupRangeSlider(settingsFormContent);
    }

    // Setup Range Slider
    function setupRangeSlider(container) {
        container.querySelectorAll('input[type="range"]').forEach(range => {
            const valueSpan = document.getElementById(range.id + '-value');
            const updateSpan = () => {
                if (valueSpan) {
                    valueSpan.textContent = `(${parseFloat(range.value).toFixed(1)}%)`;
                }
            };
            range.addEventListener('input', updateSpan);
            updateSpan();
        });
    }

    // Apply Preset
    function applyPreset(presetName) {
        const selectedPreset = presets[presetName];
        for (const key in selectedPreset) {
            const input = gameSettingsForm.elements[key];
            if (input) {
                input.value = selectedPreset[key];
                if (input.type === 'range') {
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
        }
    }

    document.getElementById('preset-house-advantage').addEventListener('click', () => applyPreset('house_advantage'));
    document.getElementById('preset-balanced').addEventListener('click', () => applyPreset('balanced'));
    document.getElementById('preset-player-friendly').addEventListener('click', () => applyPreset('player_friendly'));

    // Submit Game Settings Form
    gameSettingsForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(gameSettingsForm);
        const data = Object.fromEntries(formData.entries());

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° username ‡πÅ‡∏•‡∏∞ useAgentSettings
        data.username = currentUsername;
        data.useAgentSettings = useAgentSettings.checked;

        try {
            const response = await fetch('/api/user/update-player-settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                Swal.fire({ 
                    icon: 'success', 
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 
                    text: result.message, 
                    timer: 2000, 
                    showConfirmButton: false 
                });
                gameSettingsModal.hide();
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            Swal.fire({ 
                icon: 'error', 
                title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', 
                text: error.message 
            });
        }
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    loadPlayers();
});
</script>

<%- include('partials/footer') %>