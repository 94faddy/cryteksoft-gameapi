<%- include('partials/header') %>
<style>
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° Preset */
    .preset-btn-group .btn {
        margin: 0 5px;
        font-size: 0.9rem;
    }
</style>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô API</h1>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <i class="bi bi-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </div>
    <div class="card-body">
        <input type="text" id="userSearchInput" class="form-control" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠, Username, ‡∏´‡∏£‡∏∑‡∏≠ API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table" id="usersTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Username</th>
                        <th>API Key</th>
                        <th>Secret</th>
                        <th>Callback URL</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                <% users.forEach(user => { %>
                    <tr>
                        <td><%= user.name %></td>
                        <td><%= user.username %></td>
                        <td><code><%= user.apikey %></code></td>
                        <td><code><%= user.secret %></code></td>
                        <td><%= user.callback %></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn" data-bs-toggle="modal" data-bs-target="#editUserModal" data-user-id="<%= user._id %>" data-user-name="<%= user.name %>" data-user-username="<%= user.username %>" data-user-ip="<%= user.ip %>" data-user-callback="<%= user.callback %>" data-user-secret="<%= user.secret %>">
                                <i class="bi bi-pencil-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                            <button class="btn btn-sm btn-outline-info settings-btn" data-user-id="<%= user._id %>">
                                <i class="bi bi-gear-fill"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°
                            </button>                            
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-user-id="<%= user._id %>" data-user-name="<%= user.name %>">
                                <i class="bi bi-trash-fill"></i> ‡∏•‡∏ö
                            </button>
                        </td>
                    </tr>
                <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm" action="/admin/api/update-user" method="POST">
                <div class="modal-header"><h5 class="modal-title">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="hidden" id="edit-userId" name="userId">
                    <div class="mb-3"><label for="edit-name" class="form-label">Name</label><input type="text" class="form-control" id="edit-name" name="name"></div>
                    <div class="mb-3"><label for="edit-username" class="form-label">Username</label><input type="text" class="form-control" id="edit-username" name="username"></div>
                    <div class="mb-3"><label for="edit-ip" class="form-label">IP Address</label><input type="text" class="form-control" id="edit-ip" name="ip"></div>
                    <div class="mb-3"><label for="edit-callback" class="form-label">Callback URL</label><input type="text" class="form-control" id="edit-callback" name="callback"></div>
                    <hr>
                    <div class="mb-3"><label for="edit-new_password" class="form-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label><input type="password" class="form-control" id="edit-new_password" name="new_password"></div>
                    <hr>
                    <div class="mb-3"><label for="edit-admin_password" class="form-label fw-bold text-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label><input type="password" class="form-control" id="edit-admin_password" name="admin_password" required></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button></div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="gameSettingsModal" tabindex="-1" aria-labelledby="gameSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="gameSettingsForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="gameSettingsModalLabel">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö: <span id="settings-modal-username" class="fw-bold"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4 p-3 bg-light rounded">
                        <h6 class="mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Presets)</h6>
                        <div class="preset-btn-group">
                            <button type="button" class="btn btn-sm btn-outline-danger" id="admin-preset-house-advantage">‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á (RTP ~7-10%)</button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="admin-preset-balanced">‡∏™‡∏°‡∏î‡∏∏‡∏• (RTP ~55-65%, ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</button>
                            <button type="button" class="btn btn-sm btn-outline-success" id="admin-preset-player-friendly">‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö (RTP ~55-65%)</button>
                        </div>
                        
                        <!-- ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ Presets -->
                        <div class="mt-3 text-start">
                            <div class="alert alert-info mb-0">
                                <small>
                                    <strong>üìå ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</strong><br>
                                    ‚Ä¢ <strong>‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á:</strong> Free Spin ‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡∏°‡∏≤‡∏Å, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡πÑ‡∏£ ~90-93%<br>
                                    ‚Ä¢ <strong>‡∏™‡∏°‡∏î‡∏∏‡∏•:</strong> ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ä‡∏ô‡∏∞ 25-30%, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö ~35-45%<br>
                                    ‚Ä¢ <strong>‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö:</strong> Free Spin ‡∏≠‡∏≠‡∏Å‡∏ö‡πà‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏ô‡πâ‡∏≠‡∏¢ ~35-45%
                                </small>
                            </div>
                        </div>
                    </div>
                    <div id="settings-form-content">
                        </div>
                    <div id="settings-form-loader" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                        <p class="mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label for="settings-admin_password" class="form-label fw-bold text-danger">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</label>
                        <input type="password" class="form-control" id="settings-admin_password" name="admin_password" required autocomplete="current-password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // =================================================================
    // START: ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ‡πÅ‡∏•‡∏∞ ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
    // =================================================================
    const editUserModalEl = document.getElementById('editUserModal');
    if (editUserModalEl) {
        const editUserModal = new bootstrap.Modal(editUserModalEl);
        const editUserForm = document.getElementById('editUserForm');
        const editUserIdInput = document.getElementById('edit-userId');
        const editNameInput = document.getElementById('edit-name');
        const editUsernameInput = document.getElementById('edit-username');
        const editIpInput = document.getElementById('edit-ip');
        const editCallbackInput = document.getElementById('edit-callback');

        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function () {
                const userData = this.dataset;
                editUserIdInput.value = userData.userId;
                editNameInput.value = userData.userName;
                editUsernameInput.value = userData.userUsername;
                editIpInput.value = userData.userIp;
                editCallbackInput.value = userData.userCallback;
            });
        });

        editUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(editUserForm);
            const data = Object.fromEntries(formData.entries());
            try {
                const response = await fetch('/admin/api/update-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: result.message }).then(() => window.location.reload());
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: error.message });
            }
        });
    }

    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.dataset.userId;
            const userName = this.dataset.userName;
            Swal.fire({
                title: `‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô "${userName}" ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!`,
                icon: 'warning', showCancelButton: true,
                confirmButtonColor: '#d33', cancelButtonColor: '#3085d6',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!', cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
                        input: 'password', inputAttributes: { autocapitalize: 'off' },
                        showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                        showLoaderOnConfirm: true,
                        preConfirm: (admin_password) => {
                            return fetch('/admin/api/delete-user', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ userId, admin_password })
                            })
                            .then(response => {
                                if (!response.ok) { return response.json().then(err => { throw new Error(err.message) }); }
                                return response.json();
                            })
                            .catch(error => { Swal.showValidationMessage(`‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error}`) });
                        },
                        allowOutsideClick: () => !Swal.isLoading()
                    }).then((result) => {
                        if (result.isConfirmed && result.value.success) {
                            Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß' }).then(() => window.location.reload());
                        }
                    });
                }
            });
        });
    });

    // ===============================================================
    // START: ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" ‡πÅ‡∏•‡∏∞ "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡∏°"
    // ===============================================================
    const searchInput = document.getElementById('userSearchInput');
    const tableBody = document.getElementById('usersTableBody');
    if (!tableBody) { return; }
    const rows = tableBody.getElementsByTagName('tr');

    searchInput.addEventListener('keyup', function() {
        const filter = searchInput.value.toLowerCase();
        for (let i = 0; i < rows.length; i++) {
            let row = rows[i];
            let textContent = row.textContent || row.innerText;
            if (textContent.toLowerCase().indexOf(filter) > -1) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        }
    });

    const gameSettingsModalEl = document.getElementById('gameSettingsModal');
    if(gameSettingsModalEl) {
        const gameSettingsModal = new bootstrap.Modal(gameSettingsModalEl);
        const gameSettingsForm = document.getElementById('gameSettingsForm');
        const settingsFormContent = document.getElementById('settings-form-content');
        const settingsFormLoader = document.getElementById('settings-form-loader');
        const settingsModalUsername = document.getElementById('settings-modal-username');
        let currentUserId = null;

        const defaultSettings = {
            'normal-spin': 85, 'less-bet': 35, 'less-bet-from': 0, 'less-bet-to': 1,
            'more-bet': 8, 'more-bet-from': 2, 'more-bet-to': 4,
            'freespin-less-bet': 1, 'freespin-less-bet-from': 0, 'freespin-less-bet-to': 4,
            'freespin-more-bet': 0, 'freespin-more-bet-from': 50, 'freespin-more-bet-to': 60,
            'buy-feature-less-bet': 90, 'buy-feature-less-bet-from': 0, 'buy-feature-less-bet-to': 50,
            'buy-feature-more-bet': 4, 'buy-feature-more-bet-from': 50, 'buy-feature-more-bet-to': 60
        };

        // Presets ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß - ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÉ‡∏´‡∏°‡πà
        const presets = {
            house_advantage: { // ‡∏à‡∏≤‡∏Å update-settings.js (RTP ~7-10%, ‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡∏™‡∏π‡∏á)
                'normal-spin': 85, 'less-bet': 12, 'less-bet-from': 0, 'less-bet-to': 0.5,
                'more-bet': 3, 'more-bet-from': 0.8, 'more-bet-to': 2,
                'freespin-less-bet': 2, 'freespin-less-bet-from': 0, 'freespin-less-bet-to': 0,
                'freespin-more-bet': 0.5, 'freespin-more-bet-from': 0, 'freespin-more-bet-to': 15,
                'buy-feature-less-bet': 80, 'buy-feature-less-bet-from': 0, 'buy-feature-less-bet-to': 20,
                'buy-feature-more-bet': 8, 'buy-feature-more-bet-from': 20, 'buy-feature-more-bet-to': 60
            },
            balanced: { // ‡∏à‡∏≤‡∏Å update-settings-v2.js (RTP ~55-65%, ‡∏™‡∏°‡∏î‡∏∏‡∏•)
                'normal-spin': 50, 'less-bet': 35, 'less-bet-from': 0, 'less-bet-to': 1.2,
                'more-bet': 15, 'more-bet-from': 1.5, 'more-bet-to': 4,
                'freespin-less-bet': 3, 'freespin-less-bet-from': 2, 'freespin-less-bet-to': 10,
                'freespin-more-bet': 1, 'freespin-more-bet-from': 10, 'freespin-more-bet-to': 30,
                'buy-feature-less-bet': 65, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 40,
                'buy-feature-more-bet': 20, 'buy-feature-more-bet-from': 40, 'buy-feature-more-bet-to': 100
            },
            player_friendly: { // ‡∏à‡∏≤‡∏Å update-settings-v4.js (RTP ~55-65%, ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö)
                'normal-spin': 55, 'less-bet': 32, 'less-bet-from': 0.2, 'less-bet-to': 1.1,
                'more-bet': 13, 'more-bet-from': 1.5, 'more-bet-to': 3.5,
                'freespin-less-bet': 1.5, 'freespin-less-bet-from': 1, 'freespin-less-bet-to': 8,
                'freespin-more-bet': 0.5, 'freespin-more-bet-from': 8, 'freespin-more-bet-to': 20,
                'buy-feature-less-bet': 70, 'buy-feature-less-bet-from': 5, 'buy-feature-less-bet-to': 30,
                'buy-feature-more-bet': 15, 'buy-feature-more-bet-from': 30, 'buy-feature-more-bet-to': 80
            }
        };

        function applyPreset(presetName) {
            const selectedPreset = presets[presetName];
            for (const key in selectedPreset) {
                const input = gameSettingsForm.elements[key];
                if (input) {
                    input.value = selectedPreset[key];
                    if (input.type === 'range') {
                        input.dispatchEvent(new Event('input', { bubbles: true }));
                    }
                }
            }
        }
        
        document.getElementById('admin-preset-house-advantage').addEventListener('click', () => applyPreset('house_advantage'));
        document.getElementById('admin-preset-balanced').addEventListener('click', () => applyPreset('balanced'));
        document.getElementById('admin-preset-player-friendly').addEventListener('click', () => applyPreset('player_friendly'));

        function setupRangeSlider(container) {
            container.querySelectorAll('input[type="range"]').forEach(range => {
                const valueSpan = document.getElementById(range.id + '-value'); 
                const updateSpan = () => {
                    if (valueSpan) {
                        valueSpan.textContent = `(${parseFloat(range.value).toFixed(1)}%)`;
                    }
                };
                range.addEventListener('input', updateSpan);
                updateSpan();
            });
        }

        function buildSettingsForm(settings) {
            const formHtml = `
                <input type="hidden" name="userId" value="${currentUserId}">
                <div class="row">
                    ${Object.keys(defaultSettings).map(key => {
                        const value = settings[key] !== undefined ? settings[key] : defaultSettings[key];
                        const label = key.replace(/-/g, ' ');
                        
                        // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á Slider (step="0.1" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
                        if (key.includes('-bet') && !key.includes('-from') && !key.includes('-to') || key.includes('normal-spin')) {
                            return `
                            <div class="col-md-6 mb-3">
                                <label for="setting-${key}" class="form-label">${label} 
                                    <span id="setting-${key}-value" class="text-primary fw-bold"></span>
                                </label>
                                <input type="range" class="form-range" id="setting-${key}" name="${key}" min="0.1" max="100" step="0.1" value="${value}">
                            </div>`;
                        } else { 
                            // ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç step="0.1" ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
                            return `
                            <div class="col-md-6 mb-3">
                                <label for="setting-${key}" class="form-label">${label}</label>
                                <input type="number" min="0" step="0.1" class="form-control" id="setting-${key}" name="${key}" value="${value}">
                            </div>`;
                        }
                    }).join('')}
                </div>
            `;
            settingsFormContent.innerHTML = formHtml;
            setupRangeSlider(settingsFormContent);
        }

        document.querySelectorAll('.settings-btn').forEach(button => {
            button.addEventListener('click', async function() {
                currentUserId = this.getAttribute('data-user-id');
                const userName = this.closest('tr').cells[0].textContent;
                
                settingsModalUsername.textContent = userName;
                settingsFormContent.innerHTML = '';
                settingsFormLoader.classList.remove('d-none');
                gameSettingsModal.show();
                try {
                    const response = await fetch(`/admin/api/get-user-settings/${currentUserId}`);
                    const data = await response.json();
                    if (!data.success) throw new Error(data.message);
                    const settings = { ...defaultSettings, ...data.settings };
                    buildSettingsForm(settings);
                } catch (error) {
                    Swal.fire({ icon: 'error', title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ: ' + error.message });
                    gameSettingsModal.hide();
                } finally {
                    settingsFormLoader.classList.add('d-none');
                }
            });
        });

        gameSettingsForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(gameSettingsForm);
            const data = Object.fromEntries(formData.entries());

            if (!data.admin_password) {
                Swal.fire({ icon: 'warning', title: '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô Admin ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô' });
                return;
            }
            try {
                const response = await fetch('/admin/api/update-user-settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    Swal.fire({ icon: 'success', title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', text: result.message, timer: 2000, showConfirmButton: false });
                    gameSettingsModal.hide();
                    gameSettingsForm.reset();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                Swal.fire({ icon: 'error', title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: error.message });
            }
        });
    }
});
</script>

<%- include('partials/footer') %>
