<%- include('partials/header') %>

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="bi bi-person-circle me-2"></i>จัดการ Username (ผู้เล่น)</h1>
</div>

<!-- ฟิลเตอร์ -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-funnel-fill me-2"></i>ตัวกรองข้อมูล
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Agent</label>
                <select id="filterAgent" class="form-select">
                    <option value="all">ทั้งหมด</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">จากวันที่</label>
                <input type="text" id="filterStartDate" class="form-control" placeholder="MM/DD/YYYY" />
            </div>
            <div class="col-md-3">
                <label class="form-label">ถึงวันที่</label>
                <input type="text" id="filterEndDate" class="form-control" placeholder="MM/DD/YYYY" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button id="btnSearch" class="btn btn-primary w-100">
                    <i class="bi bi-search me-1"></i>ค้นหา
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ค้นหา Username -->
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <i class="bi bi-search"></i> ค้นหา Username
    </div>
    <div class="card-body">
        <input type="text" id="usernameSearchInput" class="form-control" placeholder="พิมพ์ Username หรือชื่อ Agent เพื่อค้นหา...">
    </div>
</div>

<!-- สถิติรวม -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title">สถิติรวม (<span id="stats-display-title">ทั้งหมด</span>)</h5>
        <div class="row text-center">
            <div class="col-md-3">
                <div class="card bg-info text-white p-3">
                    <h6 class="mb-0">จำนวน Username</h6>
                    <h4 id="total-usernames">0</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white p-3">
                    <h6 class="mb-0">Total Bet</h6>
                    <h4 id="total-bet">0.00</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white p-3">
                    <h6 class="mb-0">Total Win</h6>
                    <h4 id="total-win">0.00</h4>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white p-3">
                    <h6 class="mb-0">Win/Loss</h6>
                    <h4 id="total-winloss">0.00</h4>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ตารางแสดง Username -->
<div class="card shadow-sm">
    <div class="card-header">
        <i class="bi bi-table me-2"></i>รายชื่อ Username ทั้งหมด
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="usernamesTable">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Agent</th>
                        <th>Total Bet</th>
                        <th>Total Win</th>
                        <th>Win/Loss</th>
                        <th>Spin</th>
                        <th>เล่นล่าสุด</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usernamesTableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">กำลังโหลดข้อมูล...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal แสดงประวัติ -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="historyModalLabel">
                    <i class="bi bi-clock-history me-2"></i>ประวัติการเล่นของ: <span id="modal-username" class="fw-bold"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- ฟิลเตอร์วันที่และเวลา -->
                <div class="card mb-3">
                    <div class="card-header">
                        <i class="bi bi-funnel-fill me-2"></i>กรองข้อมูล
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-2">
                                <label class="form-label">จากวันที่</label>
                                <input type="text" id="modalStartDate" class="form-control" placeholder="MM/DD/YYYY" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">เวลา</label>
                                <input type="time" id="modalStartTime" class="form-control" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">ถึงวันที่</label>
                                <input type="text" id="modalEndDate" class="form-control" placeholder="MM/DD/YYYY" />
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">เวลา</label>
                                <input type="time" id="modalEndTime" class="form-control" />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="btnModalSearch" class="btn btn-primary w-100">
                                    <i class="bi bi-search me-1"></i>ค้นหา
                                </button>
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button id="btnModalReset" class="btn btn-secondary w-100">
                                    <i class="bi bi-arrow-clockwise me-1"></i>รีเซ็ต
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- สถิติย่อย -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <strong>Total Bet:</strong>
                                <h5 id="modal-total-bet" class="text-primary">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Total Win:</strong>
                                <h5 id="modal-total-win" class="text-success">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Win/Loss:</strong>
                                <h5 id="modal-win-loss" class="text-danger">0.00</h5>
                            </div>
                            <div class="col-md-3">
                                <strong>Spin:</strong>
                                <h5 id="modal-total-games" class="text-info">0</h5>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ตารางประวัติ -->
                <div class="table-responsive">
                    <table class="table table-sm table-bordered table-hover" id="historyTable">
                        <thead class="table-light">
                            <tr>
                                <th>วันที่/เวลา</th>
                                <th>เกม</th>
                                <th>Provider</th>
                                <th>Bet</th>
                                <th>Win</th>
                                <th>Win/Loss</th>
                                <th>Currency</th>
                                <th>Agent</th>
                                <th>Transaction ID</th>
                            </tr>
                        </thead>
                        <tbody id="historyTableBody">
                            <tr>
                                <td colspan="9" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
            </div>
        </div>
    </div>
</div>

<style>
    #historyTable img.game-icon {
        width: 32px;
        height: 32px;
        border-radius: 5px;
        margin-right: 8px;
        vertical-align: middle;
    }
    #historyTable th, #historyTable td {
        white-space: nowrap;
        vertical-align: middle;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const usernamesTableBody = document.getElementById('usernamesTableBody');
    const usernameSearchInput = document.getElementById('usernameSearchInput');
    const filterAgent = document.getElementById('filterAgent');
    const filterStartDate = document.getElementById('filterStartDate');
    const filterEndDate = document.getElementById('filterEndDate');
    const btnSearch = document.getElementById('btnSearch');
    
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    const modalUsername = document.getElementById('modal-username');
    const historyTableBody = document.getElementById('historyTableBody');
    const modalStartDate = document.getElementById('modalStartDate');
    const modalEndDate = document.getElementById('modalEndDate');
    const modalStartTime = document.getElementById('modalStartTime');
    const modalEndTime = document.getElementById('modalEndTime');
    const btnModalSearch = document.getElementById('btnModalSearch');
    const btnModalReset = document.getElementById('btnModalReset');

    let currentUsername = '';
    let allUsernames = [];

    // เริ่มต้น Datepicker
    const startDatePicker = $(filterStartDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const endDatePicker = $(filterEndDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const modalStartDatePicker = $(modalStartDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });
    const modalEndDatePicker = $(modalEndDate).datepicker({ uiLibrary: 'bootstrap5', format: 'mm/dd/yyyy' });

    // โหลดรายชื่อ Agent
    async function loadAgents() {
        try {
            const response = await fetch('/admin/api/agents-list');
            const result = await response.json();
            if (result.success) {
                result.agents.forEach(agent => {
                    const option = document.createElement('option');
                    option.value = agent._id;
                    option.textContent = `${agent.name} (${agent.username})`;
                    filterAgent.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading agents:', error);
        }
    }

    // โหลดรายชื่อ Username
    async function loadUsernames(agentId = 'all', start = '', end = '') {
        usernamesTableBody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">กำลังโหลดข้อมูล...</p></td></tr>';
        
        try {
            let url = `/admin/api/all-usernames?agentId=${agentId}`;
            if (start && end) {
                url += `&start=${start}&end=${end}`;
            }

            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                allUsernames = result.usernames;
                displayUsernames(allUsernames);
                updateStats(allUsernames);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error loading usernames:', error);
            usernamesTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">เกิดข้อผิดพลาด: ' + error.message + '</td></tr>';
        }
    }

    // แสดง Username ในตาราง
    function displayUsernames(usernames) {
        if (usernames.length === 0) {
            usernamesTableBody.innerHTML = '<tr><td colspan="8" class="text-center">ไม่พบข้อมูล</td></tr>';
            return;
        }

        usernamesTableBody.innerHTML = usernames.map(user => {
            const winLossClass = user.winLoss >= 0 ? 'text-success' : 'text-danger';
            const lastPlayed = new Date(user.lastPlayed).toLocaleString('th-TH');
            
            return `
                <tr>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.agentName}<br><small class="text-muted">(${user.agentUsername})</small></td>
                    <td>${user.totalBet.toFixed(2)}</td>
                    <td>${user.totalWin.toFixed(2)}</td>
                    <td class="${winLossClass}">${user.winLoss.toFixed(2)}</td>
                    <td>${user.totalGames}</td>
                    <td><small>${lastPlayed}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-history-btn" data-username="${user.username}">
                            <i class="bi bi-clock-history me-1"></i>ดูประวัติ
                        </button>
                    </td>
                </tr>
            `;
        }).join('');

        // ผูก Event ให้กับปุ่มดูประวัติ
        document.querySelectorAll('.view-history-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                currentUsername = this.getAttribute('data-username');
                loadUserHistory(currentUsername);
            });
        });
    }

    // อัปเดตสถิติรวม
    function updateStats(usernames) {
        const stats = usernames.reduce((acc, user) => {
            acc.totalBet += user.totalBet;
            acc.totalWin += user.totalWin;
            acc.totalWinLoss += user.winLoss;
            return acc;
        }, { totalBet: 0, totalWin: 0, totalWinLoss: 0 });

        document.getElementById('total-usernames').textContent = usernames.length;
        document.getElementById('total-bet').textContent = stats.totalBet.toFixed(2);
        document.getElementById('total-win').textContent = stats.totalWin.toFixed(2);
        document.getElementById('total-winloss').textContent = stats.totalWinLoss.toFixed(2);
    }

    // ค้นหา Username
    usernameSearchInput.addEventListener('keyup', function() {
        const filter = this.value.toLowerCase();
        const rows = usernamesTableBody.getElementsByTagName('tr');

        for (let row of rows) {
            const textContent = row.textContent || row.innerText;
            if (textContent.toLowerCase().indexOf(filter) > -1) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    });

    // ปุ่มค้นหา
    btnSearch.addEventListener('click', function() {
        const agentId = filterAgent.value;
        const start = startDatePicker.value();
        const end = endDatePicker.value();

        if (start && !end || !start && end) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกทั้งวันที่เริ่มต้นและวันที่สิ้นสุด', 'warning');
            return;
        }

        loadUsernames(agentId, start, end);
    });

    // โหลดประวัติ Username
    async function loadUserHistory(username, start = '', end = '', startTime = '', endTime = '') {
        modalUsername.textContent = username;
        historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center"><div class="spinner-border text-primary" role="status"></div></td></tr>';
        historyModal.show();

        try {
            let url = `/admin/api/username-detail/${username}`;
            const params = [];
            if (start) params.push(`start=${start}`);
            if (end) params.push(`end=${end}`);
            if (startTime) params.push(`startTime=${startTime}`);
            if (endTime) params.push(`endTime=${endTime}`);
            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            const response = await fetch(url);
            const result = await response.json();

            if (result.success) {
                displayUserHistory(result.history, result.summary);
            } else {
                throw new Error(result.message);
            }
        } catch (error) {
            console.error('Error loading user history:', error);
            historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">เกิดข้อผิดพลาด: ' + error.message + '</td></tr>';
        }
    }

    // แสดงประวัติในตาราง (อัพเดทเพื่อแสดงรูปภาพและชื่อเกม)
    function displayUserHistory(history, summary) {
        // อัปเดตสถิติ
        document.getElementById('modal-total-bet').textContent = summary.totalBet.toFixed(2);
        document.getElementById('modal-total-win').textContent = summary.totalWin.toFixed(2);
        document.getElementById('modal-win-loss').textContent = summary.winLoss.toFixed(2);
        document.getElementById('modal-total-games').textContent = summary.totalGames;

        if (history.length === 0) {
            historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center">ไม่พบข้อมูล</td></tr>';
            return;
        }

        historyTableBody.innerHTML = history.map(tx => {
            const winLossClass = tx.winLoss >= 0 ? 'text-success' : 'text-danger';
            const createdDate = new Date(tx.createdDate).toLocaleString('th-TH');
            const gameDisplay = `<img src="${tx.imageUrl}" class="game-icon" alt="${tx.gameName}" onerror="this.onerror=null;this.src='/img/default-game.png';"><span>${tx.gameName}</span>`;
            
            return `
                <tr>
                    <td><small>${createdDate}</small></td>
                    <td>${gameDisplay}</td>
                    <td>${tx.productId}</td>
                    <td>${tx.betAmount.toFixed(2)}</td>
                    <td>${tx.payoutAmount.toFixed(2)}</td>
                    <td class="${winLossClass}">${tx.winLoss.toFixed(2)}</td>
                    <td>${tx.currency}</td>
                    <td><small>${tx.agentName}<br>(${tx.agentUsername})</small></td>
                    <td><small>${tx.transactionId}</small></td>
                </tr>
            `;
        }).join('');
    }

    // ปุ่มค้นหาใน Modal
    btnModalSearch.addEventListener('click', function() {
        const start = modalStartDatePicker.value();
        const end = modalEndDatePicker.value();
        const startTime = modalStartTime.value;
        const endTime = modalEndTime.value;

        if (start && !end || !start && end) {
            Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกทั้งวันที่เริ่มต้นและวันที่สิ้นสุด', 'warning');
            return;
        }

        loadUserHistory(currentUsername, start, end, startTime, endTime);
    });

    // ปุ่มรีเซ็ตใน Modal
    btnModalReset.addEventListener('click', function() {
        modalStartDatePicker.value('');
        modalEndDatePicker.value('');
        modalStartTime.value = '';
        modalEndTime.value = '';
        loadUserHistory(currentUsername);
    });

    // โหลดข้อมูลเริ่มต้น
    loadAgents();
    loadUsernames();
});
</script>

<%- include('partials/footer') %>
